version: '3.8'

services:
  # ================================
  # LDAP Service
  # ================================
  ldap-service:
    image: osixia/openldap:1.5.0
    container_name: hr-ldap
    hostname: ldap.safran.local
    environment:
      - LDAP_ORGANISATION=${LDAP_ORGANIZATION:-Safran Corporation}
      - LDAP_DOMAIN=${LDAP_DOMAIN:-safran.local}
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD:-SecureAdminPass123!}
      - LDAP_CONFIG_PASSWORD=${LDAP_ADMIN_PASSWORD:-SecureAdminPass123!}
      - LDAP_RFC2307BIS_SCHEMA=true
      - LDAP_REMOVE_CONFIG_AFTER_SETUP=true
      - LDAP_TLS_VERIFY_CLIENT=never
      - LDAP_TLS=false
    ports:
      - "389:389"
      - "636:636"
    volumes:
      - ldap-data:/var/lib/ldap
      - ldap-config:/etc/ldap/slapd.d
    networks:
      - hr-chatbot-network
    healthcheck:
      test: [ "CMD-SHELL", "ldapsearch -x -H ldap://localhost -b dc=safran,dc=local -D 'cn=admin,dc=safran,dc=local' -w ${LDAP_ADMIN_PASSWORD:-SecureAdminPass123!} || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # Ollama LLM Service
  # ================================
  ollama:
    image: ollama/ollama:latest
    container_name: hr-ollama
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - hr-chatbot-network
    healthcheck:
      test: [ "CMD", "ollama", "list" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ================================
  # Backend API Service
  # ================================
  backend-api:
    image: serini/safran-backend-api:v4.0
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hr-backend
    environment:
      - LDAP_SERVER=${LDAP_SERVER:-ldap://ldap-service:389}
      - LDAP_BASE_DN=${LDAP_BASE_DN:-dc=safran,dc=local}
      - LDAP_ADMIN_DN=${LDAP_ADMIN_DN:-cn=admin,dc=safran,dc=local}
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD:-SecureAdminPass123!}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      - JWT_REFRESH_SECRET_KEY=${JWT_REFRESH_SECRET_KEY:-your-refresh-secret-key}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-60}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:5173}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2:3b}
      - ENVIRONMENT=${ENVIRONMENT:-development}

    ports:
      - "8000:8000"
    depends_on:
      ldap-service:
        condition: service_healthy
    networks:
      - hr-chatbot-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ================================
  # Frontend UI Service
  # ================================
  frontend-ui:
    image: serini/safran-frontend-ui:v4.0
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:8000}
    container_name: hr-frontend
    ports:
      - "5173:80"
    depends_on:
      - backend-api
    networks:
      - hr-chatbot-network
    restart: unless-stopped

networks:
  hr-chatbot-network:
    driver: bridge
    name: hr-chatbot-network

volumes:
  ldap-data:
    name: hr-ldap-data
  ldap-config:
    name: hr-ldap-config
  ollama-data:
    name: hr-ollama-data
